<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMART-RDS User Portal</title>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:900px;margin:auto;background:white;border-radius:20px;padding:25px;box-shadow:0 20px 40px rgba(0,0,0,.15)}
h1{text-align:center;margin-bottom:10px}
.sub{text-align:center;color:#555;margin-bottom:25px}
.section{margin-bottom:30px;background:#f8f9ff;padding:20px;border-radius:15px}
.row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px}
label{font-weight:600;margin-bottom:6px;display:block}
input,select{padding:10px;border-radius:8px;border:2px solid #ddd;width:100%}
.btn{margin-top:15px;padding:12px;border:none;border-radius:10px;background:#667eea;color:white;font-weight:bold;cursor:pointer}
.status{margin-top:10px;font-size:.9rem}
.status.ok{color:#155724}
.status.err{color:#721c24}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
th{background:#667eea;color:white}
.muted{color:#777;font-size:.9rem}
@media(max-width:700px){.row{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="container">
  <h1>SMART-RDS User Portal</h1>
  <p class="sub">Check your ration history and shop refill status</p>

  <!-- Search -->
  <div class="section">
    <h2>üîç Check Ration Status</h2>
    <div class="row">
      <div>
        <label>Ration Card ID</label>
        <input id="rationId" placeholder="TN-09-1234567890">
      </div>
      <div>
        <label>Shop ID</label>
        <select id="shopId">
          <option>TN001</option>
        </select>
      </div>
      <div>
        <label>Card Type</label>
        <select>
          <option>AAY</option>
          <option>PHH</option>
          <option>NPHH</option>
        </select>
      </div>
    </div>
    <button class="btn" onclick="checkStatus()">üìÑ Show Shop Refill & Bills</button>
    <div id="searchStatus" class="status"></div>
  </div>

  <!-- Shop Status -->
  <div class="section">
    <h2>‚úÖ Shop Refill Status (Govt ‚Üí Shop)</h2>
    <div id="shopStatus" class="muted">No data loaded.</div>
  </div>

  <!-- Bills -->
  <div class="section">
    <h2>üìú Last 5 Bills (Your Card)</h2>
    <div id="billsBox" class="muted">No bills to show.</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCf5yQAkQGICClkV1p39p8dqNIiZQoKeKc",
  databaseURL: "https://smart-rds-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

async function checkStatus(){
  const cardId = document.getElementById("rationId").value.trim();
  const shopId = document.getElementById("shopId").value;
  const st = document.getElementById("searchStatus");

  if(!/^TN-\d{2}-\d{10}$/.test(cardId)){
    st.textContent = "Invalid Card ID format";
    st.className = "status err";
    return;
  }

  st.textContent = "Loading‚Ä¶";
  st.className = "status";

  try{
    // ---------- SHOP STATUS ----------
    const totalsSnap = await db.ref(`shops/${shopId}/stockTotals`).once("value");
    renderShopStatus(totalsSnap.val());

    // ---------- USER BILLS (FIXED PATH) ----------
    const billsSnap = await db.ref(`shops/${shopId}/users/${cardId}/bills`)
      .limitToLast(5).once("value");

    const bills = [];
    if(billsSnap.exists()){
      billsSnap.forEach(ch => bills.push(ch.val()));
      bills.reverse();
    }
    renderBills(bills);

    st.textContent = "Data loaded from shop " + shopId;
    st.className = "status ok";

  }catch(e){
    console.error(e);
    st.textContent = "Error loading data";
    st.className = "status err";
  }
}

function renderBills(bills){
  const box = document.getElementById("billsBox");
  if(!bills || bills.length===0){
    box.innerHTML = "<p class='muted'>No bills found.</p>";
    return;
  }
  let html = "<table><tr><th>Date</th><th>Items</th></tr>";
  bills.forEach(b=>{
    html += `<tr>
      <td>${b.date || '-'}</td>
      <td>${b.items || '-'}</td>
    </tr>`;
  });
  html += "</table>";
  box.innerHTML = html;
}

function renderShopStatus(totals){
  const box = document.getElementById("shopStatus");
  if(!totals){
    box.innerHTML = "<p class='muted'>No government stock data.</p>";
    return;
  }
  let html = "<table><tr><th>Item</th><th>Total Govt Stock</th></tr>";
  Object.keys(totals).forEach(k=>{
    html += `<tr><td>${k.toUpperCase()}</td><td>${totals[k]}</td></tr>`;
  });
  html += "</table>";
  box.innerHTML = html;
}
</script>
</body>
</html>
